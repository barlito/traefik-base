version: "3.8"

# Production override - uses Docker configs (no rsync needed!)

configs:
  traefik_static:
    file: ./traefik.prod.yml
  traefik_dynamic:
    file: ./traefik-dynamic.prod.yml

services:
  traefik:
    ports:
      # Override to use mode: host (Swarm limitation: can't publish TCP+UDP on same port in ingress mode)
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: udp
        mode: host
      - target: 8080
        published: 8080
        protocol: tcp
        mode: host
    environment:
      - ENV=prod
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${ACME_EMAIL}
    deploy:
      labels:
        # Define basicauth middleware with environment variable
        - traefik.http.middlewares.dashboard-auth.basicauth.users=${DASHBOARD_AUTH}
        # Override dashboard router to use auth
        - traefik.http.routers.dashboard.middlewares=dashboard-auth@swarm,security-headers@file
    configs:
      - source: traefik_static
        target: /etc/traefik/traefik.yml
        mode: 0444
      - source: traefik_dynamic
        target: /etc/traefik/dynamic/config.yml
        mode: 0444
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/etc/traefik

volumes:
  traefik-data:
